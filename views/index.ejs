<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sondage Politique</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Tajawal&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" href="public/favicon.png" type="image/png">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<!----------------Rubrique page global -------------------->
<body>
<div class="container">
  <div class="entete">
    <img src="/images/entete.jpg" alt="Image centrÃ©e">
  </div>
  <div class="text-defilant">
    <p>le prÃ©mier institut de sondage en Mauritanie</p>
  </div>
  <br>
 <!----------------Rubrique Top candidats -------------------->
  <% if (topCandidat) { %>
    <div class="top-candidat">
      <div class="candidat top">
        <h3>Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ© Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ© ÙÙŠ Ù…ÙˆØ±ÙŠØªØ§Ù†ÙŠØ§</h3>
        <h3>La personnalitÃ© politique la plus populaire en Mauritanie</h3> 
        <div id="date-heure"></div>
        <hr style="border: none; height: 1px; background-color: #ffffff; margin: 10px 0;">
        <img src="/uploads/<%= topCandidat.photo %>" alt="<%= topCandidat.nom %>" class="photo-candidat-top" />
        <h3><%= topCandidat.nom %></h3>
        <% if (totalVotes > 0) { %>
          <p><strong>Pourcentage :</strong> <%= ((topCandidat.votes / totalVotes) * 100).toFixed(1) %>%</p>
          <p><strong>Total votes :</strong> <%= totalVotes %></p>
        <% } else { %>
          <p><strong>Pourcentage :</strong> 0%</p>
          <p><strong>Total votes :</strong> 0</p>
        <% } %>
        <p class="top-candidat-description"><%= topCandidat.description || '' %></p>
      </div>
    </div>
    <% } %>
 <!----------------Rubrique titre des candidats -------------------->
    <div class="titre">
      <h4>ØµÙˆØª Ù„Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ© Ø§Ù„Ø£ÙØ¶Ù„ Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„Ùƒ<br>Choisissez votre personnalitÃ© politique prÃ©fÃ©rÃ©e</h4>
    </div>      
  <!----------------Rubrique candidats vote -------------------->
  <section class="slider-section">
    <div class="slider-wrapper">
      <div class="slider-track">
        <div class="candidats">
          <% candidats.forEach(candidat => { 
            const pourcentage = totalVotes > 0 ? ((candidat.votes / totalVotes) * 100).toFixed(1) : 0;
          %>
            <div class="candidat">
              <div class="tooltip">  
                <p><strong>Total votes :</strong> <%= totalVotes %></p>                         
                <img src="/uploads/<%= candidat.photo %>" alt="<%= candidat.nom %>" class="photo-candidat" 
                     onerror="this.src='/uploads/default.jpg'"/>
                <span class="tooltiptext">
                  <%= candidat.nom %> <%= candidat.fonction %><br><%= candidat.description || '' %>
                </span>
              </div>
              <p>
                <span class="votes" id="vote-count-<%= candidat.id %>"><%= candidat.votes %></span></br>
                (<%= pourcentage %>%)
              </p>             
              <div class="candid">
                <div class="progress-barC-background">
                    <div class="progress-barC" 
                         id="progress-candidat-<%= candidat.id %>" 
                         data-percentage="<%= pourcentage %>">
                         0% <!-- Texte initial -->
                 
                       "<%= pourcentage %>"
                       <%= pourcentage %>%
                
                  </div>
                </div>             
              </div>           
              <br>  
            
              <button type="button" class="vote-button" onclick="voterPourCandidat('<%= candidat.id %>', event)">Voter</button>
              <div id="message-<%= candidat.id %>" class="message-feedback" style="display:none; margin-top:8px; font-weight:bold;"></div>
              
              


              
            </div>
          <% }); %>
        </div>
      </div>
    </div>
  </section>

 
  <div class="banner-carousel">
    <% bannieres.forEach(banniere => { %>
      <img class="banner-slide" src="/uploads/<%= banniere.image %>" alt="<%= banniere.titre %>">
    <% }) %>
  </div></br>
 


<!--------Rubrique secteurs vote -->
<div class="section-secteurs">   
          <div class="titre-ligne">
            <h3>ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù…Ø¤Ø³Ø³Ø§Øª Ø§Ù„Ø¹Ù…ÙˆÙ…ÙŠØ©<br>Ã‰valuation des institutions publiques</h3>
            <hr>
          </div>
    <div class="container-secteurs">
      <% secteurs.forEach(function(secteur) { %>
        <div class="carte-secteurs">
          <div class="secteur">
            <div class="logo-secteur">
              <% if (secteur.logo) { %>
                <p><span id="total-global-votes"><%= totalGlobalVotes %></span> votes</br>
               Total votes secteur: <span id="total-secteur-<%= secteur.id %>"><%= secteur.votes_oui + secteur.votes_non %></span></p>
                <hr style="border: none; height: 1px; background-color: #f8f8f7; margin: 10px 0;"> 
                <img src="/uploads/<%= secteur.logo %>" alt="Logo <%= secteur.nom %>">          
              <% } else { %>
                <p>Pas de logo disponible</p>
              <% } %>
            </div>
                <h2 class="titre-arabe"><%= secteur.nom_ar %></h2>
                <h2 class="titre-francais"><%= secteur.nom %></h2>
                <hr style="border: none; height: 1px; background-color: #f08f07; margin: 10px 0;">   
              <div id="secteur-<%= secteur.id %>">
                   <div class="total-votants" id="total-<%= secteur.id %>">
                    <p>Votes Oui : <span id="oui-count-<%= secteur.id %>"><%= secteur.votes_oui %></span></p>
                    <p>Votes Non : <span id="non-count-<%= secteur.id %>"><%= secteur.votes_non %></span></p>
                     <p><strong>Satisfaction :</strong> <span id="pourcentage-<%= secteur.id %>"><%= secteur.pourcentage.toFixed(2) %></span>%</p>
                    </div>
                    <div class="progress-container">
                     <div id="progression-<%= secteur.id %>" class="progress-bar" data-pourcentage="<%= secteur.pourcentage.toFixed(1) %>">
                     <%= secteur.pourcentage.toFixed(1) %>%
                    </div>
                    </div><br>
                    <form id="voteForm-<%= secteur.id %>" method="POST">
                      <input type="hidden" name="secteurId" value="<%= secteur.id %>">
                      <button type="submit" class="vote-btn btn-oui" data-secteur="<%= secteur.id %>" data-reponse="oui">ğŸ˜Š Voter Oui</button>
                      <button type="submit" class="vote-btn btn-non" data-secteur="<%= secteur.id %>" data-reponse="non">ğŸ˜ Voter Non</button>
                    </form>
                    <div id="message-<%= secteur.id %>" class="vote-message"></div>
              </div>
          </div>
        </div>
      <% }); %>
    </div>  
 </div></br>



 <!----------------Rubrique satisfaction du gov -------------------->
 <div id="satisfaction-section">
  <h4>Ã‰valuation du gouvernement</h4>
  <img id="satisfaction-image" src="/images/prsidence.jpg" alt="Satisfaction" />
  <h3>
    Ù‡Ù„ Ø§Ù†Øª Ø±Ø§Ø¶ Ø¹Ù† Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­ÙƒÙˆÙ…Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©<br />
    ÃŠtes-vous satisfait de la performance du gouvernement ?
  </h3>
  <div class="vote-container">
    <div class="vote-result">
      <p><span id="result-oui"><%= satisfactionStats.oui || 0 %></span></p>
      <button type="button" onclick="voterSatisfaction('oui')">Oui</button>

   

    </div>
    <div class="vote-result">
      <p><span id="result-non"><%= satisfactionStats.non || 0 %></span></p>
      <button type="button" onclick="voterSatisfaction('non')">Non</button>
    </div>
  </div>
  <div class="vote-feedback" id="vote-feedback" style="display:none;">Merci pour votre vote ! ğŸ™</div>
</div>

<!----------------Rubrique footer -------------------->
  <footer>
    ÙŠØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø´Ø§Ø±ÙƒÙŠÙ† ÙÙŠ Ø§Ù„Ø§Ø³ØªØ·Ù„Ø§Ø¹ Ø­Ø³Ø¨ Ù…Ø¹Ø§ÙŠÙŠØ±Ø®Ø§ØµØ© ÙˆØ´Ø±ÙˆØ· Ù…Ø­Ø¯Ø¯Ø© ÙˆØ¯Ù‚ÙŠÙ‚Ø© 
    <div class="entete">
      <img src="/images/entete.jpg" alt="Image centrÃ©e">
      Tous droits rÃ©servÃ©s &copy; institut de sondage Mizane Echaab 2025 - NKC.Mr &copy;47 69 69 69
    </div>
  </footer>
</div>

<script>
function voterPourCandidat(id) {
  // Cacher les messages au dÃ©but
  document.getElementById(`message-success-${id}`).style.display = 'none';
  document.getElementById(`message-error-${id}`).style.display = 'none';

  fetch(`/vote-candidat/${id}`, {
    method: 'POST'
  })
  .then(response => {
    if (!response.ok) {
      // Affiche un message si le vote est refusÃ© (dÃ©jÃ  votÃ©)
      document.getElementById(`message-error-${id}`).style.display = 'block';
      return;
    }
    return response.json();
  })
  .then(data => {
    if (data && data.message) {
      // Vote acceptÃ© : incrÃ©mente visuellement
      const compteur = document.getElementById(`votes-${id}`);
      compteur.textContent = parseInt(compteur.textContent) + 1;

      // Affiche le message de succÃ¨s
      document.getElementById(`message-success-${id}`).style.display = 'block';
    }
  })
  .catch(error => {
    console.error("Erreur:", error);
  });
}




function voterPourCandidat(id, event) {
  console.log("Fonction voterPourCandidat atteinte !");
  event.preventDefault();

  fetch(`/vote-candidat/${id}`, {
    method: 'POST'
  })
  .then(response => {
    if (!response.ok) {
      // Affiche un message HTML plutÃ´t qu'une alerte
      const message = document.getElementById(`message-${id}`);
      message.textContent = "â›” Vous avez dÃ©jÃ  votÃ©.";
      message.style.color = "white";
      message.style.display = "block";
      return;
    }
    return response.json();
  })
  .then(data => {
    if (data && data.message) {
      const compteur = document.getElementById(`votes-${id}`);
      const bar = document.getElementById(`bar-${id}`);
      const message = document.getElementById(`message-${id}`);

      // Met Ã  jour le nombre de votes (affichÃ©)
      if (compteur) {
        compteur.textContent = parseInt(compteur.textContent) + 1;
      }

      // Met Ã  jour la barre de progression si `data.pourcentage` est fourni
      if (data.pourcentage && bar) {
        bar.style.width = `${data.pourcentage}%`;
        bar.textContent = `${data.pourcentage}%`;
      }

      // Affiche le message de succÃ¨s
      message.textContent = "âœ… Merci pour votre vote !";
      message.style.color = "white";
      message.style.display = "block";
    }
  })
  .catch(error => {
    console.error("Erreur:", error);
  });
}









</script>

<script>
function voterSatisfaction(reponse) {
  const feedback = document.getElementById('vote-feedback');
  console.log("Vote envoyÃ© :", reponse);

  fetch('/satisfaction/vote-satisfaction', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ reponse })
  })
  .then(async response => {
    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.message || 'Une erreur est survenue.');
    }

    // SuccÃ¨s
    feedback.textContent = 'âœ… Merci ! Votre vote a bien Ã©tÃ© enregistrÃ©.';
    feedback.style.backgroundColor = '#d4edda';
    feedback.style.color = '#155724';
    feedback.style.border = '1px solid #c3e6cb';
    feedback.style.display = 'block';
  })
  .catch(error => {
    // Erreur ou vote dÃ©jÃ  effectuÃ©
    const msg = error.message.includes('dÃ©jÃ ') 
      ? 'âš ï¸ Vous avez dÃ©jÃ  votÃ©. Merci!.'
      : 'âŒ Une erreur est survenue. Veuillez rÃ©essayer.';

    feedback.textContent = msg;
    feedback.style.backgroundColor = '#fc0718';
    feedback.style.color = '#fffcfc';
    feedback.style.border = '1px solid #f5c6cb';
    feedback.style.display = 'block';
  });
}

  </script>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const slides = document.querySelectorAll(".banner-slide");
  let currentIndex = 0;
  const delay = 4000; // 4 secondes

  if (slides.length === 0) return; // Pas d'image, rien Ã  faire

  slides[currentIndex].classList.add("active");

  setInterval(() => {
    slides[currentIndex].classList.remove("active");
    currentIndex = (currentIndex + 1) % slides.length;
    slides[currentIndex].classList.add("active");
  }, delay);
});
</script>
<script>
  document.querySelectorAll('.vote-btn').forEach(button => {
    button.addEventListener('click', function (e) {
      e.preventDefault(); // empÃªche le formulaire de se soumettre normalement

      const secteurId = this.dataset.secteur;
      const reponse = this.dataset.reponse;

      fetch(`/secteurs/vote/${secteurId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `reponse=${encodeURIComponent(reponse)}`
      })
      .then(res => res.json())
      .then(data => {
        const msgDiv = document.getElementById(`message-${secteurId}`);
        if (data.message) {
          msgDiv.textContent = data.message;
          msgDiv.style.color = 'green';
        } else if (data.error) {
          msgDiv.textContent = data.error;
          msgDiv.style.color = 'red';
        }
      })
      .catch(err => {
        console.error('Erreur lors du vote secteur:', err);
      });
    });
  });
</script>
<style>
.progress-bar {
  height: 24px;
  background-color: #4CAF50;
  color: white;
  text-align: center;
  line-height: 24px;
  transition: width 0.5s ease-in-out; /* ğŸ‘ˆ Animation fluide */
  border-radius: 5px;
}




</style>
<script src="/script.js"></script>
</body>
</html>